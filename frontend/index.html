<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8" />
  <title>ü§ñ AI Math Quest ‚Äî “ö–∞–∑–∞“õ—à–∞ –Ω“±—Å“õ–∞ + –¢–∞–π–º–µ—Ä</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e2ebf0,#cfd9df);
      color:#222;text-align:center;padding:20px;transition:background .3s ease}
    .card{background:#fff;padding:18px;border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.1);width:420px;margin:20px auto;
      transition:transform .3s ease,box-shadow .3s ease}
    .card:hover{transform:scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.15)}
    input{padding:10px;border-radius:8px;border:1px solid #ccc;width:80%;margin:10px 0;
      text-align:center;font-size:16px}
    button{padding:10px 14px;border-radius:8px;margin:6px;cursor:pointer;border:none;
      font-size:15px;background:#4CAF50;color:#fff;transition:background .2s}
    button:hover{background:#3e8e41}
    #progress{height:20px;background:#4caf50;border-radius:12px;width:0;color:#fff;
      line-height:20px;transition:width .3s}
    #feedback{font-size:18px;font-weight:bold;margin-top:10px;min-height:30px;
      transition:color .3s,transform .3s}
    .mute-btn{position:fixed;top:10px;right:10px;background:#2196F3;border-radius:50%;
      width:40px;height:40px;color:white;font-size:18px}
    #timer{font-weight:bold;font-size:18px;color:#ff5722;margin:10px 0;}
  </style>
</head>
<body>
<h1>ü§ñ AI Math Quest (“ö–∞–∑–∞“õ—à–∞)</h1>
<button class="mute-btn" id="muteBtn">üîä</button>

<div id="login" class="card">
  <label>–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:</label><br/>
  <input id="playerName" placeholder="–û–π—ã–Ω—à—ã" /><br/>
  <button id="startBtn">–ë–∞—Å—Ç–∞—É</button>
</div>

<div id="game" class="card" style="display:none">
  <div>–û–π—ã–Ω—à—ã: <b id="playerLabel"></b></div>
  <div>–î–µ“£–≥–µ–π: <b id="levelLabel">1</b> | “∞–ø–∞–π: <b id="scoreLabel">0</b></div>
  <div id="timer">‚è±Ô∏è 15 —Å–µ–∫—É–Ω–¥</div>
  <div style="background:#ddd;padding:3px;border-radius:12px;margin:10px 0">
    <div id="progress">0%</div>
  </div>

  <p id="question">–°“±—Ä–∞“õ...</p>
  <input id="answerInput" type="number" step="any" placeholder="–ñ–∞—É–∞–±—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑" /><br/>
  <button id="submitBtn">–ñ–∞—É–∞–ø –±–µ—Ä—É</button>
  <button id="hintBtn">–ö–µ“£–µ—Å (-5 “±–ø–∞–π)</button>

  <p id="feedback"></p>
  <h3>üèÜ –ö”©—à–±–∞—Å—à—ã–ª–∞—Ä</h3>
  <ol id="leaders"></ol>
</div>

<script>
const API="http://127.0.0.1:8000";
let player=null,currentQuestion=null,hintUsed=false,muted=false;
let timeLeft=15,timerInterval=null;

// üéµ –î—ã–±—ã—Å—Ç–∞—Ä
const correctSound=new Audio("sounds/correct.mp3");
const wrongSound=new Audio("sounds/wrong.mp3");
const comboSound=new Audio("sounds/combo.mp3");
const bgMusic=new Audio("sounds/bg.mp3");
bgMusic.loop=true;bgMusic.volume=0.3;

document.getElementById('muteBtn').onclick=()=>{
  muted=!muted;
  document.getElementById('muteBtn').innerText=muted?"üîà":"üîä";
  [correctSound,wrongSound,comboSound,bgMusic].forEach(a=>a.muted=muted);
};

const el={
  login:document.getElementById('login'),
  playerName:document.getElementById('playerName'),
  startBtn:document.getElementById('startBtn'),
  game:document.getElementById('game'),
  playerLabel:document.getElementById('playerLabel'),
  question:document.getElementById('question'),
  answerInput:document.getElementById('answerInput'),
  submitBtn:document.getElementById('submitBtn'),
  feedback:document.getElementById('feedback'),
  scoreLabel:document.getElementById('scoreLabel'),
  levelLabel:document.getElementById('levelLabel'),
  progress:document.getElementById('progress'),
  leaders:document.getElementById('leaders'),
  hintBtn:document.getElementById('hintBtn'),
  timer:document.getElementById('timer')
};

// üöÄ –û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É
el.startBtn.onclick=async()=>{
  player=el.playerName.value.trim()||"–û–π—ã–Ω—à—ã";
  const res=await fetch(`${API}/register/${encodeURIComponent(player)}`);
  const data=await res.json();
  el.playerLabel.innerText=player;
  el.scoreLabel.innerText=data.score||0;
  el.levelLabel.innerText=data.level||1;
  el.login.style.display="none";
  el.game.style.display="block";
  if(!muted)bgMusic.play().catch(()=>{});
  getQuestion();
  updateLeaderboard();
};

// üî¢ –°“±—Ä–∞“õ –∞–ª—É
async function getQuestion(){
  clearInterval(timerInterval);
  timeLeft=15;
  updateTimer();
  timerInterval=setInterval(()=>{
    timeLeft--;
    updateTimer();
    if(timeLeft<=0){
      clearInterval(timerInterval);
      el.feedback.style.color="red";
      el.feedback.innerText="‚è∞ –£–∞“õ—ã—Ç –±—ñ—Ç—Ç—ñ!";
      if(!muted)wrongSound.play();
      sendAnswer(NaN,true); // —É–∞“õ—ã—Ç –±—ñ—Ç–∫–µ–Ω
    }
  },1000);

  const res=await fetch(`${API}/question/${encodeURIComponent(player)}`);
  const data=await res.json();
  currentQuestion=data.question;
  el.question.innerText=`(${data.level}-–¥–µ“£–≥–µ–π) ${currentQuestion}`;
  el.feedback.innerText="";
  el.answerInput.value="";
}

// ‚è±Ô∏è –¢–∞–π–º–µ—Ä –∂–∞“£–∞—Ä—Ç—É
function updateTimer(){
  el.timer.innerText=`‚è±Ô∏è ${timeLeft} —Å–µ–∫—É–Ω–¥`;
  if(timeLeft<=5) el.timer.style.color="red";
  else el.timer.style.color="#ff5722";
}

// ‚úÖ –ñ–∞—É–∞–ø –±–µ—Ä—É
el.submitBtn.onclick=()=>sendAnswer(parseFloat(el.answerInput.value),false);

async function sendAnswer(val,isTimeout){
  clearInterval(timerInterval);
  if(isTimeout){
    val=-9999; // —É–∞“õ—ã—Ç –±—ñ—Ç—Å–µ, –∂–∞—É–∞–ø “õ–∞—Ç–µ
  }else if(isNaN(val)){
    alert("–ñ–∞—É–∞–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!");
    getQuestion();
    return;
  }
  const payload={player,question:currentQuestion,user_answer:val};
  const res=await fetch(`${API}/answer`,{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
  });
  const data=await res.json();
  if(data.is_correct){
    el.feedback.style.color="green";
    el.feedback.innerText="‚úÖ –î“±—Ä—ã—Å! –ñ–∞—Ä–∞–π—Å—ã“£!";
    if(!muted)correctSound.play();
  }else{
    el.feedback.style.color="red";
    el.feedback.innerText=`‚ùå “ö–∞—Ç–µ! –î“±—Ä—ã—Å –∂–∞—É–∞–ø: ${data.correct_answer}`;
    if(!muted)wrongSound.play();
  }
  el.scoreLabel.innerText=data.score;
  el.levelLabel.innerText=data.new_level;
  el.progress.style.width=data.progress+"%";
  el.progress.innerText=data.progress+"%";
  setTimeout(getQuestion,2000);
}

// üí° –ö–µ“£–µ—Å
el.hintBtn.onclick=()=>{
  const score=parseInt(el.scoreLabel.innerText)||0;
  if(score<5)return alert("“∞–ø–∞–π –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑!");
  if(hintUsed)return alert("–ë“±—Ä—ã–Ω “õ–æ–ª–¥–∞–Ω—ã–ª–¥—ã!");
  hintUsed=true;
  el.feedback.innerText="üí° –ö–µ“£–µ—Å: –∞–º–∞–ª“ì–∞ –º“±“õ–∏—è—Ç “õ–∞—Ä–∞!";
  el.feedback.style.color="blue";
  el.scoreLabel.innerText=Math.max(score-5,0);
};

// üèÜ –ö”©—à–±–∞—Å—à—ã–ª–∞—Ä
async function updateLeaderboard(){
  const res=await fetch(`${API}/leaderboard`);
  const data=await res.json();
  el.leaders.innerHTML='';
  data.slice(0,10).forEach(p=>{
    const li=document.createElement('li');
    li.innerText=`${p.player}: ${p.score}`;
    el.leaders.appendChild(li);
  });
}
setInterval(updateLeaderboard,5000);
</script>
</body>
</html>
