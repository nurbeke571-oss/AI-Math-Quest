<!doctype html>
<html lang="kk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåü AI Math Quest  UI</title>
    <style>
        /* 1. –ñ–ê–õ–ü–´ –ñ”ò–ù–ï –§–û–ù */
        :root{
            --primary-color: #007bff; /* –ö”©–∫ */
            --success-color: #28a745; /* –ñ–∞—Å—ã–ª */
            --danger-color: #dc3545; /* “ö—ã–∑—ã–ª */
            --warning-color: #ffc107; /* –°–∞—Ä—ã */
            --bg-light: #f8f9fa;
            --bg-dark: #343a40;
            --text-dark: #212529;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: var(--text-dark);
            text-align: center;
            padding: 20px;
            transition: background-color .5s ease, background .5s ease;
        }
        
        /* 2. –ö–ê–†–¢–û–ß–ö–ê (CARD) –°–¢–ò–õ–¨–î–ï–†–Ü */
        .card{
            background: #ffffff;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            width: 90%;
            max-width: 480px;
            margin: 20px auto;
            transition: transform .4s ease, box-shadow .4s ease;
            animation: fadeIn 1s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 3. –û–ô–´–ù –ò–ù–¢–ï–†–§–ï–ô–°–Ü–ù–Ü“¢ –°–¢–ò–õ–Ü */
        h1{ color: var(--primary-color); font-weight: 700; margin-bottom: 25px; }
        
        input[type="text"], input[type="number"]{
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #ced4da;
            width: 85%;
            margin: 10px 0;
            text-align: center;
            font-size: 17px;
            transition: border-color .3s;
        }
        input:focus{ border-color: var(--primary-color); outline: none; }
        
        button{
            padding: 12px 20px;
            border-radius: 10px;
            margin: 8px;
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            transition: background-color .3s, transform .1s;
        }
        button:hover{ transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #startBtn{ background: var(--primary-color); }
        #startBtn:hover{ background: #0056b3; }
        #submitBtn{ background: var(--success-color); }
        #submitBtn:hover{ background: #1e7e34; }
        #hintBtn{ background: var(--warning-color); color: var(--text-dark); }
        #hintBtn:hover{ background: #d39e00; }
        
        /* 4. –ü–†–û–ì–†–ï–°–° –ñ”ò–ù–ï –¢–ê–ô–ú–ï–† */
        .stats-grid{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            background: var(--bg-light);
        }
        .stat-item{
            font-size: 14px;
            font-weight: 500;
            padding: 5px;
            border-radius: 5px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stat-item b{ display: block; font-size: 18px; font-weight: 700; color: var(--primary-color); }
        
        #progressContainer{
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            margin: 15px 0;
            overflow: hidden;
        }
        #progress{
            height: 100%;
            background: linear-gradient(90deg, #17a2b8, var(--success-color));
            width: 0%;
            color: #fff;
            line-height: 30px;
            transition: width 0.6s ease-out; /* üìà –ê–Ω–∏–º–∞—Ü–∏—è */
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        #timer{
            font-weight: 700;
            font-size: 20px;
            color: var(--danger-color);
            margin: 15px 0;
            transition: transform .1s;
        }
        
        /* 5. –ö–ï–†–Ü –ë–ê–ô–õ–ê–ù–´–° –ñ”ò–ù–ï –ê–ù–ò–ú–ê–¶–ò–Ø–õ–ê–† */
        #feedback{
            font-size: 20px;
            font-weight: 700;
            margin-top: 20px;
            min-height: 40px;
            transition: color .4s, transform .4s, opacity .4s;
            animation: feedbackPop .3s ease-out;
        }
        @keyframes feedbackPop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .mute-btn{
            position: fixed; top: 20px; right: 20px; background: var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px; color: white; font-size: 20px;
            line-height: 50px; text-align: center; border: none; cursor: pointer; z-index: 10;
        }
        
        /* 6. –ö”®–®–ë–ê–°–®–´–õ–ê–† –¢–ê“ö–¢–ê–°–´ (LEADERBOARD) */
        #leaders{
            list-style-type: none;
            padding: 0;
            text-align: left;
        }
        #leaders li{
            background: #e9ecef;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            font-weight: 500;
            border-left: 5px solid var(--primary-color);
            transition: background .3s;
        }
        #leaders li:nth-child(1){ border-left-color: gold; font-weight: 700; background: #fff3cd; }
        #leaders li:nth-child(2){ border-left-color: silver; background: #e2e6ea; }
        #leaders li:nth-child(3){ border-left-color: #cd7f32; background: #f0e68c; }

        /* 7. –ê–î–ê–ü–¢–ò–í–¢–Ü–ö (MEDIA QUERIES) */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .card { width: 95%; padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .mute-btn { width: 40px; height: 40px; font-size: 16px; line-height: 40px; }
        }
    </style>
</head>
<body id="body">
    <h1>ü§ñ AI Math Quest (“ö–∞–∑–∞“õ—à–∞) üß†</h1>
    <button class="mute-btn" id="muteBtn">üîä</button>

    <div id="login" class="card">
        <h2>–û–π—ã–Ω“ì–∞ –ö—ñ—Ä—É</h2>
        <label for="playerName">–ê—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:</label>
        <input id="playerName" type="text" placeholder="–û–π—ã–Ω—à—ã –ê—Ç—ã" /><br/>
        <button id="startBtn">‚ñ∂Ô∏è –û–π—ã–Ω–¥—ã –ë–∞—Å—Ç–∞—É</button>
    </div>

    <div id="game" class="card" style="display:none">
        <h2>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –ú–∏—Å—Å–∏—è</h2>
        
        <div class="stats-grid">
            <div class="stat-item">–û–π—ã–Ω—à—ã: <b id="playerLabel">...</b></div>
            <div class="stat-item">–î–µ“£–≥–µ–π: <b id="levelLabel">1</b></div>
            <div class="stat-item">“∞–ø–∞–π: <b id="scoreLabel">0</b></div>
        </div>

        <div id="timer">‚è±Ô∏è 15 —Å–µ–∫—É–Ω–¥</div>
        
        <div id="progressContainer">
            <div id="progress">0%</div>
        </div>

        <p id="question">–°“±—Ä–∞“õ –∂“Ø–∫—Ç–µ–ª—É–¥–µ...</p>
        
        <input id="answerInput" type="number" step="any" placeholder="–ñ–∞—É–∞–±—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" /><br/>
        
        <button id="submitBtn">‚úÖ –ñ–∞—É–∞–ø –±–µ—Ä—É</button>
        <button id="hintBtn">üí° –ö–µ“£–µ—Å (-5 “±–ø–∞–π)</button>

        <p id="feedback"></p>
        
        <hr/>
        <h3>üèÜ –ö”©—à–±–∞—Å—à—ã–ª–∞—Ä –¢–∞“õ—Ç–∞—Å—ã</h3>
        <ol id="leaders"></ol>
    </div>

<script>
    // –ë“±—Ä—ã–Ω“ì—ã–¥–∞–π JavaScript –ª–æ–≥–∏–∫–∞—Å—ã –º“±–Ω–¥–∞ –∂–∞–ª“ì–∞—Å–∞–¥—ã...
    const API = ""; 
    let player = null, currentQuestion = null, hintUsed = false, muted = false;
    let timeLeft = 15, timerInterval = null;

    // üéµ –î—ã–±—ã—Å—Ç–∞—Ä
    const correctSound = new Audio("sounds/correct.mp3");
    const wrongSound = new Audio("sounds/wrong.mp3");
    const comboSound = new Audio("sounds/combo.mp3");
    const bgMusic = new Audio("sounds/bg.mp3");
    bgMusic.loop = true; bgMusic.volume = 0.3;

    document.getElementById('muteBtn').onclick = () => {
        muted = !muted;
        document.getElementById('muteBtn').innerText = muted ? "üîà" : "üîä";
        [correctSound, wrongSound, comboSound, bgMusic].forEach(a => a.muted = muted);
    };

    const el = {
        body: document.getElementById('body'), // –ñ–∞“£–∞: –î–µ–Ω–µ —ç–ª–µ–º–µ–Ω—Ç—ñ
        login: document.getElementById('login'),
        playerName: document.getElementById('playerName'),
        startBtn: document.getElementById('startBtn'),
        game: document.getElementById('game'),
        playerLabel: document.getElementById('playerLabel'),
        question: document.getElementById('question'),
        answerInput: document.getElementById('answerInput'),
        submitBtn: document.getElementById('submitBtn'),
        feedback: document.getElementById('feedback'),
        scoreLabel: document.getElementById('scoreLabel'),
        levelLabel: document.getElementById('levelLabel'),
        progress: document.getElementById('progress'),
        leaders: document.getElementById('leaders'),
        hintBtn: document.getElementById('hintBtn'),
        timer: document.getElementById('timer')
    };
    
    // –ñ–∞“£–∞ —Ñ—É–Ω–∫—Ü–∏—è: –ö–µ—Ä—ñ –±–∞–π–ª–∞–Ω—ã—Å“õ–∞ —Å”ô–π–∫–µ—Å —Ñ–æ–Ω–¥—ã ”©–∑–≥–µ—Ä—Ç—É
    function setFeedbackStyle(isCorrect) {
        el.feedback.style.color = isCorrect ? 'var(--success-color)' : 'var(--danger-color)';
        el.body.style.backgroundColor = isCorrect ? '#e8f5e9' : '#ffebee'; // –ê—à—ã“õ –∂–∞—Å—ã–ª/“õ—ã–∑—ã–ª —Ñ–æ–Ω
        
        setTimeout(() => {
             // 500 –º—Å –∫–µ–π—ñ–Ω —Ñ–æ–Ω–¥—ã –±–∞—Å—Ç–∞–ø“õ—ã –∫“Ø–π—ñ–Ω–µ “õ–∞–π—Ç–∞—Ä—É
            el.body.style.backgroundColor = '#e0f7fa'; 
        }, 500);
    }

    // üöÄ –û–π—ã–Ω–¥—ã –±–∞—Å—Ç–∞—É
    el.startBtn.onclick = async () => {
        player = el.playerName.value.trim() || "–û–π—ã–Ω—à—ã";
        try {
            // üõë –¢“Æ–ó–ï–¢–£: –°”ô—Ç—Å—ñ–∑ –∂–∞—É–∞–ø—Ç—ã —Ç–µ–∫—Å–µ—Ä—É (–ë“±—Ä—ã–Ω“ì—ã–¥–∞–π “õ–∞–ª–¥—ã—Ä—ã–ª“ì–∞–Ω)
            const res = await fetch(`${API}/register/${encodeURIComponent(player)}`); 
            if (!res.ok) throw new Error(`–¢—ñ—Ä–∫–µ—É “õ–∞—Ç–µ—Å—ñ: ${res.status}`);
            
            const data = await res.json();
            
            el.playerLabel.innerText = player;
            el.scoreLabel.innerText = data.current_score || 0; 
            el.levelLabel.innerText = data.current_level || 1; 

            el.login.style.display = "none";
            el.game.style.display = "block";
            if (!muted) bgMusic.play().catch(() => {});
            getQuestion();
            updateLeaderboard();
        } catch (e) {
            console.error("–¢—ñ—Ä–∫–µ–ª—É –Ω–µ–º–µ—Å–µ —Å“±—Ä–∞“õ –∞–ª—É —Å”ô—Ç—Å—ñ–∑ –∞—è“õ—Ç–∞–ª–¥—ã:", e);
            alert("–°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å “õ–∞—Ç–µ—Å—ñ. –ö–æ–Ω—Å–æ–ª—å–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.");
        }
    };

    // üî¢ –°“±—Ä–∞“õ –∞–ª—É
    async function getQuestion() {
        clearInterval(timerInterval);
        timeLeft = 15;
        updateTimer();
        el.answerInput.disabled = false;
        el.submitBtn.disabled = false;
        el.hintBtn.disabled = false;
        hintUsed = false; // –ö–µ“£–µ—Å—Ç—ñ “õ–∞–π—Ç–∞ –æ—Ä–Ω–∞—Ç—É
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                el.feedback.innerText = "‚è∞ –£–∞“õ—ã—Ç –±—ñ—Ç—Ç—ñ!";
                el.answerInput.disabled = true;
                el.submitBtn.disabled = true;
                el.hintBtn.disabled = true;
                if (!muted) wrongSound.play();
                setFeedbackStyle(false); // “ö–∞—Ç–µ —Å—Ç–∏–ª—ñ–Ω “õ–æ–ª–¥–∞–Ω—É
                sendAnswer("timeout", true);
            }
        }, 1000);

        try {
            const res = await fetch(`${API}/question/${encodeURIComponent(player)}`);
            if (!res.ok) throw new Error(`–°“±—Ä–∞“õ “õ–∞—Ç–µ—Å—ñ: ${res.status}`);
            
            const data = await res.json();
            
            if (!data.math_question || !data.current_level) {
                throw new Error("–ë—ç–∫—ç–Ω–¥—ñ–¥–µ–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä —Ç–æ–ª—ã“õ –∫–µ–ª–º–µ–¥—ñ.");
            }

            currentQuestion = data.math_question;
            el.question.innerText = `(${data.current_level}-–¥–µ“£–≥–µ–π) ${currentQuestion}`;

            el.feedback.innerText = "";
            el.answerInput.value = "";
        } catch (e) {
            console.error("–°“±—Ä–∞“õ –∞–ª—É —Å”ô—Ç—Å—ñ–∑ –∞—è“õ—Ç–∞–ª–¥—ã:", e);
            el.question.innerText = "‚ùå –°“±—Ä–∞“õ –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ";
            el.levelLabel.innerText = "N/A";
            el.scoreLabel.innerText = "N/A";
        }
    }

    // ‚è±Ô∏è –¢–∞–π–º–µ—Ä –∂–∞“£–∞—Ä—Ç—É
    function updateTimer() {
        el.timer.innerText = `‚è±Ô∏è ${timeLeft} —Å–µ–∫—É–Ω–¥`;
        if (timeLeft <= 5) {
            el.timer.style.color = 'var(--danger-color)';
            // üö® –î–∏–Ω–∞–º–∏–∫–∞–ª—ã“õ –µ—Å–∫–µ—Ä—Ç—É
            el.timer.style.transform = timeLeft % 2 === 0 ? 'scale(1.1)' : 'scale(1)'; 
        } else {
            el.timer.style.color = '#ff5722';
            el.timer.style.transform = 'scale(1)';
        }
    }

    // ‚úÖ –ñ–∞—É–∞–ø –±–µ—Ä—É
    el.submitBtn.onclick = () => sendAnswer(el.answerInput.value, false);

    async function sendAnswer(val, isTimeout) {
        clearInterval(timerInterval);
        el.answerInput.disabled = true;
        el.submitBtn.disabled = true;
        el.hintBtn.disabled = true;
        
        let userAnswerString;

        if (isTimeout) {
            userAnswerString = "NaN_Timeout"; 
        } else {
            const parsedVal = parseFloat(val);
            if (isNaN(parsedVal)) {
                alert("–ñ–∞—É–∞–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!");
                getQuestion();
                return;
            }
            userAnswerString = parsedVal.toString();
        }
        
        const payload = {
            player: player,
            question: currentQuestion,
            user_answer: userAnswerString
        };
        
        try {
            const res = await fetch(`${API}/answer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            
            let isCorrect = false;
            
            if (data.message && data.message.includes("—Å–∞–Ω –±–æ–ª—É—ã –∫–µ—Ä–µ–∫")) {
                el.feedback.innerText = isTimeout ? "‚è∞ –£–∞“õ—ã—Ç –±—ñ—Ç—Ç—ñ! “∞–ø–∞–π —à–µ–≥–µ—Ä—ñ–ª–¥—ñ." : data.message;
                if (!muted) wrongSound.play();
            } else if (data.is_correct) {
                el.feedback.innerText = "‚úÖ –î“±—Ä—ã—Å! –ñ–∞—Ä–∞–π—Å—ã“£!";
                isCorrect = true;
                if (!muted) correctSound.play();
            } else {
                el.feedback.innerText = `‚ùå “ö–∞—Ç–µ! –î“±—Ä—ã—Å –∂–∞—É–∞–ø: ${data.correct_answer}`;
                if (!muted) wrongSound.play();
            }
            
            setFeedbackStyle(isCorrect); // –§–æ–Ω–¥—ã –∂–∞“£–∞—Ä—Ç—É

            el.scoreLabel.innerText = data.score || 0;
            el.levelLabel.innerText = data.new_level || 1;
            el.progress.style.width = (data.progress || 0) + "%";
            el.progress.innerText = (data.progress || 0) + "%";
            
        } catch (e) {
            console.error("–ñ–∞—É–∞–ø –∂—ñ–±–µ—Ä—É “õ–∞—Ç–µ—Å—ñ:", e);
            el.feedback.innerText = "‚ùå –°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å “õ–∞—Ç–µ—Å—ñ!";
            setFeedbackStyle(false);
            if (!muted) wrongSound.play();
        }
        
        updateLeaderboard(); 
        setTimeout(getQuestion, isTimeout ? 2000 : 1500); 
    }

    // üí° –ö–µ“£–µ—Å
    el.hintBtn.onclick = () => {
        const score = parseInt(el.scoreLabel.innerText) || 0;
        if (score < 5) return alert("“∞–ø–∞–π –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑! –ö–µ“£–µ—Å “Ø—à—ñ–Ω –∫–µ–º—ñ–Ω–¥–µ 5 “±–ø–∞–π “õ–∞–∂–µ—Ç.");
        if (hintUsed) return alert("–ë“±—Ä—ã–Ω “õ–æ–ª–¥–∞–Ω—ã–ª–¥—ã!");
        
        hintUsed = true;
        el.feedback.innerText = "üí° –ö–µ“£–µ—Å: –∞–º–∞–ª“ì–∞ –º“±“õ–∏—è—Ç “õ–∞—Ä–∞! –ö“Ø—Ä–¥–µ–ª—ñ–ª—ñ–∫ –¥–µ“£–≥–µ–π—ñ–Ω–µ –Ω–∞–∑–∞—Ä –∞—É–¥–∞—Ä.";
        el.feedback.style.color = 'var(--primary-color)';
        el.scoreLabel.innerText = Math.max(score - 5, 0);
    };

    // üèÜ –ö”©—à–±–∞—Å—à—ã–ª–∞—Ä
    async function updateLeaderboard() {
        try {
            const res = await fetch(`${API}/leaderboard`);
            if (!res.ok) throw new Error('–ö”©—à–±–∞—Å—à—ã–ª–∞—Ä —Ç–∞“õ—Ç–∞—Å—ã–Ω –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ');
            const data = await res.json();
            el.leaders.innerHTML = '';
            data.slice(0, 10).forEach((p, index) => {
                const li = document.createElement('li');
                let icon = '';
                if (index === 0) icon = 'ü•á ';
                else if (index === 1) icon = 'ü•à ';
                else if (index === 2) icon = 'ü•â ';
                
                li.innerHTML = `<span>${icon}${p.player}</span> <b>${p.score} “±–ø–∞–π</b>`;
                el.leaders.appendChild(li);
            });
        } catch (e) {
            console.error("–ö”©—à–±–∞—Å—à—ã–ª–∞—Ä —Ç–∞“õ—Ç–∞—Å—ã–Ω –∂–∞“£–∞—Ä—Ç—É “õ–∞—Ç–µ—Å—ñ:", e);
        }
    }
    setInterval(updateLeaderboard, 5000);
</script>
</body>
</html>


